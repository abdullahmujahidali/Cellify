<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cellify - Spreadsheet Library Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #059669;
      --primary-hover: #047857;
      --primary-light: #D1FAE5;
      --primary-dark: #065F46;
      --black: #111827;
      --gray-900: #1F2937;
      --gray-700: #374151;
      --gray-500: #6B7280;
      --gray-300: #D1D5DB;
      --gray-200: #E5E7EB;
      --gray-100: #F3F4F6;
      --gray-50: #F9FAFB;
      --white: #FFFFFF;
      --warning: #F59E0B;
      --warning-bg: #FEF3C7;
      --error: #DC2626;
      --success: #10B981;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--black);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
    }

    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--black);
      letter-spacing: -0.5px;
    }

    .logo-text span {
      color: var(--primary);
    }

    .header-badge {
      background: var(--primary-light);
      color: var(--primary-dark);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    /* Main content */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .hero {
      text-align: center;
      margin-bottom: 40px;
    }

    .hero h1 {
      font-size: 36px;
      font-weight: 700;
      color: var(--black);
      margin: 0 0 12px 0;
      letter-spacing: -0.5px;
    }

    .hero p {
      font-size: 18px;
      color: var(--gray-500);
      margin: 0;
    }

    /* Sections */
    .section {
      background: var(--white);
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 24px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .section-icon {
      width: 44px;
      height: 44px;
      background: var(--primary-light);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .section h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--black);
      margin: 0;
    }

    .section-description {
      color: var(--gray-500);
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .section-description code {
      background: var(--gray-100);
      color: var(--primary-dark);
      padding: 2px 8px;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 13px;
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    button {
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary);
      color: var(--white);
    }

    button.primary:hover {
      background: var(--primary-hover);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    button.secondary {
      background: var(--white);
      color: var(--gray-700);
      border: 1px solid var(--gray-300);
    }

    button.secondary:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    button.outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    button.outline:hover {
      background: var(--primary-light);
    }

    button:disabled {
      background: var(--gray-200);
      color: var(--gray-500);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed var(--gray-300);
      border-radius: 16px;
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--gray-50);
      margin-bottom: 20px;
    }

    .drop-zone:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .drop-zone.dragover {
      border-color: var(--primary);
      background: var(--primary-light);
      border-style: solid;
    }

    .drop-zone input {
      display: none;
    }

    .drop-zone-icon {
      width: 64px;
      height: 64px;
      background: var(--white);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 28px;
      box-shadow: var(--shadow);
    }

    .drop-zone-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--black);
      margin: 0 0 8px 0;
    }

    .drop-zone-subtitle {
      font-size: 14px;
      color: var(--gray-500);
      margin: 0;
    }

    .drop-zone-formats {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 16px;
    }

    .format-badge {
      background: var(--white);
      color: var(--gray-700);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--gray-200);
    }

    /* Preview area */
    #preview {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
      table-layout: fixed;
    }

    th, td {
      border: 1px solid var(--gray-200);
      padding: 8px 12px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      min-width: 60px;
      overflow: hidden;
      position: relative;
    }

    th {
      background: var(--black);
      color: var(--white);
      font-weight: 600;
      position: sticky;
      top: 0;
      white-space: nowrap;
      vertical-align: middle;
      min-width: 60px;
      user-select: none;
    }

    /* Column resize handle */
    th .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      background: transparent;
      transition: background 0.2s;
    }

    th .resize-handle:hover,
    th .resize-handle.resizing {
      background: var(--primary);
    }

    th:first-child {
      background: var(--gray-900);
      min-width: 50px;
      width: 50px;
    }

    /* Row resize handle */
    tbody th .row-resize-handle {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 5px;
      cursor: row-resize;
      background: transparent;
      transition: background 0.2s;
    }

    tbody th .row-resize-handle:hover,
    tbody th .row-resize-handle.resizing {
      background: var(--primary);
    }

    tbody tr:nth-child(even) {
      background: var(--gray-50);
    }

    tbody tr:hover {
      background: var(--primary-light);
    }

    tbody td:first-child,
    tbody th:first-child {
      background: var(--gray-100);
      font-weight: 500;
      color: var(--gray-700);
      text-align: center;
      vertical-align: middle;
      min-width: 50px;
      width: 50px;
    }

    /* Resizing state */
    body.col-resizing {
      cursor: col-resize !important;
      user-select: none;
    }

    body.row-resizing {
      cursor: row-resize !important;
      user-select: none;
    }

    body.col-resizing *,
    body.row-resizing * {
      cursor: inherit !important;
    }

    /* Stats */
    .stats {
      background: var(--primary-light);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-dark);
    }

    .stat-label {
      font-size: 12px;
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Warnings */
    .warnings {
      background: var(--warning-bg);
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 4px solid var(--warning);
    }

    .warnings-title {
      font-weight: 600;
      color: var(--gray-900);
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warnings ul {
      margin: 0;
      padding-left: 20px;
      color: var(--gray-700);
    }

    .warnings li {
      margin: 4px 0;
    }

    /* Sheet tabs */
    .sheet-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      background: var(--gray-100);
      padding: 4px;
      border-radius: 12px;
    }

    .sheet-tab {
      padding: 10px 18px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: var(--gray-600);
      transition: all 0.2s ease;
    }

    .sheet-tab:hover {
      background: var(--white);
      color: var(--black);
    }

    .sheet-tab.active {
      background: var(--white);
      color: var(--primary);
      box-shadow: var(--shadow-sm);
    }

    /* Console log */
    .console {
      background: var(--gray-900);
      border-radius: 12px;
      overflow: hidden;
    }

    .console-header {
      background: var(--black);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .console-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .console-dot.red { background: #EF4444; }
    .console-dot.yellow { background: #F59E0B; }
    .console-dot.green { background: #10B981; }

    .console-title {
      color: var(--gray-400);
      font-size: 13px;
      font-weight: 500;
      margin-left: 8px;
    }

    #log {
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 12px;
      color: var(--gray-300);
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
      line-height: 1.6;
    }

    #log .error {
      color: #F87171;
    }

    #log .success {
      color: #34D399;
    }

    #log .info {
      color: #60A5FA;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 32px 24px;
      color: var(--gray-500);
      font-size: 14px;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Preview info */
    .preview-info {
      color: var(--gray-500);
      font-size: 13px;
      margin-top: 12px;
      padding: 12px;
      background: var(--gray-50);
      border-radius: 8px;
      text-align: center;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-500);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* Cell selection and editing */
    td.selected {
      outline: 2px solid var(--primary);
      outline-offset: -2px;
      background-color: var(--primary-light) !important;
    }

    /* Column/Row selection */
    th.col-selected {
      background: var(--primary) !important;
      color: white;
    }

    th.row-selected {
      background: var(--primary) !important;
      color: white;
    }

    td.col-selected,
    td.row-selected {
      background-color: rgba(5, 150, 105, 0.15) !important;
    }

    td.col-selected.row-selected {
      background-color: rgba(5, 150, 105, 0.25) !important;
    }

    /* Clickable headers */
    thead th:not(:first-child) {
      cursor: pointer;
    }

    tbody th {
      cursor: pointer;
    }

    td.editing {
      padding: 0;
      overflow: visible;
      position: relative;
    }

    td.editing input {
      position: absolute;
      left: 0;
      top: 0;
      min-width: 100%;
      width: auto;
      height: 100%;
      min-height: 32px;
      border: none;
      padding: 8px 12px;
      font-size: inherit;
      font-family: inherit;
      background: var(--white);
      outline: 2px solid var(--primary);
      box-sizing: border-box;
      z-index: 10;
    }

    td.modified::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
    }

    /* Cursor for editable cells */
    tbody td:not(:first-child) {
      cursor: cell;
    }

    td.has-comment::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 8px 8px 0;
      border-color: transparent #F59E0B transparent transparent;
    }

    /* Edit hint in info bar */
    .edit-hint {
      color: var(--gray-500);
      font-size: 12px;
      margin-top: 8px;
      text-align: center;
    }

    .edit-hint kbd {
      background: var(--gray-200);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 180px;
      z-index: 1000;
      padding: 4px 0;
      display: none;
    }

    .context-menu.visible {
      display: block;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-700);
      transition: background 0.15s;
    }

    .context-menu-item:hover {
      background: var(--gray-100);
    }

    .context-menu-item.disabled {
      color: var(--gray-400);
      cursor: not-allowed;
    }

    .context-menu-item.disabled:hover {
      background: transparent;
    }

    .context-menu-item .icon {
      width: 16px;
      text-align: center;
      font-size: 14px;
    }

    .context-menu-item .shortcut {
      margin-left: auto;
      font-size: 11px;
      color: var(--gray-400);
    }

    .context-menu-divider {
      height: 1px;
      background: var(--gray-200);
      margin: 4px 0;
    }

    .context-menu-submenu {
      position: relative;
    }

    .context-menu-submenu::after {
      content: '‚Ä∫';
      margin-left: auto;
      font-size: 14px;
      color: var(--gray-400);
    }

    .context-menu-submenu .submenu {
      position: absolute;
      left: 100%;
      top: -4px;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 140px;
      padding: 4px 0;
      display: none;
    }

    .context-menu-submenu:hover .submenu {
      display: block;
    }

    /* Color picker in context menu */
    .color-picker-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 4px;
      padding: 8px;
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid var(--gray-200);
      transition: transform 0.1s, box-shadow 0.1s;
    }

    .color-swatch:hover {
      transform: scale(1.15);
      box-shadow: var(--shadow);
    }

    .color-swatch.no-color {
      background: linear-gradient(135deg, white 45%, #ef4444 50%, white 55%);
    }

    /* Comment indicator tooltip */
    .comment-tooltip {
      position: fixed;
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      max-width: 250px;
      z-index: 999;
      box-shadow: var(--shadow-md);
      display: none;
    }

    .comment-tooltip.visible {
      display: block;
    }

    .comment-tooltip-author {
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 4px;
    }

    .comment-tooltip-text {
      color: var(--gray-600);
      line-height: 1.4;
    }

    th .filter-btn {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      background: transparent;
      border: none;
      cursor: pointer;
      opacity: 0.6;
      font-size: 10px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 3px;
      transition: all 0.15s;
    }

    th .filter-btn:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
    }

    th .filter-btn.active {
      opacity: 1;
      background: var(--primary);
      color: white;
    }

    th:first-child .filter-btn {
      display: none;
    }

    .filter-dropdown {
      position: fixed;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      min-width: 200px;
      max-width: 280px;
      z-index: 1001;
      display: none;
    }

    .filter-dropdown.visible {
      display: block;
    }

    .filter-dropdown-header {
      padding: 12px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-dropdown-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--gray-700);
    }

    .filter-dropdown-clear {
      font-size: 12px;
      color: var(--primary);
      cursor: pointer;
      background: none;
      border: none;
      padding: 4px 8px;
    }

    .filter-dropdown-clear:hover {
      text-decoration: underline;
    }

    .filter-search {
      padding: 8px 12px;
      border-bottom: 1px solid var(--gray-200);
    }

    .filter-search input {
      width: 100%;
      padding: 6px 10px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 12px;
      outline: none;
    }

    .filter-search input:focus {
      border-color: var(--primary);
    }

    .filter-options {
      max-height: 200px;
      overflow-y: auto;
      padding: 8px 0;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      color: var(--gray-700);
      transition: background 0.15s;
    }

    .filter-option:hover {
      background: var(--gray-100);
    }

    .filter-option input[type="checkbox"] {
      accent-color: var(--primary);
    }

    .filter-option-label {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .filter-option-count {
      color: var(--gray-400);
      font-size: 11px;
    }

    .filter-dropdown-footer {
      padding: 8px 12px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      gap: 8px;
    }

    .filter-dropdown-footer button {
      flex: 1;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }

    tr.filtered-out {
      display: none !important;
    }

    /* Filter indicator in header */
    th.has-filter::after {
      content: '';
      position: absolute;
      top: 4px;
      right: 4px;
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><img src="logo.svg" alt="Cellify"></div>
        <div class="logo-text">Celli<span>fy</span></div>
      </div>
      <div class="header-badge">Interactive Demo</div>
    </div>
  </header>

  <div class="container">
    <!-- Hero -->
    <div class="hero">
      <h1>Excel Import & Export Made Simple</h1>
      <p>A lightweight, zero-dependency spreadsheet library for JavaScript and TypeScript</p>
    </div>

    <!-- Export Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">üì§</div>
        <h2>Export Excel Files</h2>
      </div>
      <p class="section-description">
        Create and download sample Excel files to test the export functionality.
        Each example demonstrates different Cellify features.
      </p>

      <div class="button-group">
        <button class="primary" id="btnBasic">üìä Basic Example</button>
        <button class="primary" id="btnStyled">üé® Styled Spreadsheet</button>
        <button class="primary" id="btnFormula">üî¢ With Formulas</button>
        <button class="primary" id="btnMultiSheet">üìë Multi-Sheet</button>
        <button class="primary" id="btnComments">üí¨ With Comments</button>
      </div>
    </div>

    <!-- Import Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">üì•</div>
        <h2>Import Excel/CSV Files</h2>
      </div>
      <p class="section-description">
        Drop a file below to import and preview its contents. Supports <code>.xlsx</code> and <code>.csv</code> formats.
      </p>

      <div class="drop-zone" id="dropZone">
        <div class="drop-zone-icon">üìÅ</div>
        <p class="drop-zone-title">Drop your file here</p>
        <p class="drop-zone-subtitle">or click to browse from your computer</p>
        <div class="drop-zone-formats">
          <span class="format-badge">.xlsx</span>
          <span class="format-badge">.csv</span>
        </div>
        <input type="file" id="fileInput" accept=".xlsx,.csv">
      </div>

      <div id="importStats" style="display: none;">
        <div class="stats" id="statsContent"></div>
        <div class="warnings" id="warningsContent" style="display: none;"></div>
        <div class="sheet-tabs" id="sheetTabs"></div>
        <div id="preview"></div>

        <div class="button-group" style="margin-top: 20px;">
          <button class="primary" id="btnReExportXlsx">üì§ Re-export as XLSX</button>
          <button class="secondary" id="btnReExportCsv">üìÑ Export Current Sheet as CSV</button>
        </div>
      </div>
    </div>

    <!-- Console Section -->
    <div class="section">
      <div class="section-header">
        <div class="section-icon">üíª</div>
        <h2>Console Output</h2>
      </div>
      <div class="console">
        <div class="console-header">
          <span class="console-dot red"></span>
          <span class="console-dot yellow"></span>
          <span class="console-dot green"></span>
          <span class="console-title">Activity Log</span>
        </div>
        <div id="log"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>Built with Cellify ‚Äî A lightweight spreadsheet library for the modern web</p>
  </footer>

  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item" data-action="copy">
      <span class="icon">üìã</span>
      <span>Copy</span>
      <span class="shortcut">Ctrl+C</span>
    </div>
    <div class="context-menu-item" data-action="cut">
      <span class="icon">‚úÇÔ∏è</span>
      <span>Cut</span>
      <span class="shortcut">Ctrl+X</span>
    </div>
    <div class="context-menu-item" data-action="paste">
      <span class="icon">üìÑ</span>
      <span>Paste</span>
      <span class="shortcut">Ctrl+V</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item context-menu-submenu" data-action="fill-color">
      <span class="icon">üé®</span>
      <span>Fill Color</span>
      <div class="submenu">
        <div class="color-picker-grid" id="fillColorPicker">
          <div class="color-swatch no-color" data-color="" title="No fill"></div>
          <div class="color-swatch" style="background: #FFFFFF" data-color="#FFFFFF" title="White"></div>
          <div class="color-swatch" style="background: #F3F4F6" data-color="#F3F4F6" title="Light Gray"></div>
          <div class="color-swatch" style="background: #E5E7EB" data-color="#E5E7EB" title="Gray"></div>
          <div class="color-swatch" style="background: #6B7280" data-color="#6B7280" title="Dark Gray"></div>
          <div class="color-swatch" style="background: #111827" data-color="#111827" title="Black"></div>
          <div class="color-swatch" style="background: #FEE2E2" data-color="#FEE2E2" title="Light Red"></div>
          <div class="color-swatch" style="background: #FECACA" data-color="#FECACA" title="Red 100"></div>
          <div class="color-swatch" style="background: #F87171" data-color="#F87171" title="Red 400"></div>
          <div class="color-swatch" style="background: #EF4444" data-color="#EF4444" title="Red"></div>
          <div class="color-swatch" style="background: #DC2626" data-color="#DC2626" title="Red 600"></div>
          <div class="color-swatch" style="background: #991B1B" data-color="#991B1B" title="Dark Red"></div>
          <div class="color-swatch" style="background: #FEF3C7" data-color="#FEF3C7" title="Light Yellow"></div>
          <div class="color-swatch" style="background: #FDE68A" data-color="#FDE68A" title="Yellow 200"></div>
          <div class="color-swatch" style="background: #FBBF24" data-color="#FBBF24" title="Yellow 400"></div>
          <div class="color-swatch" style="background: #F59E0B" data-color="#F59E0B" title="Yellow"></div>
          <div class="color-swatch" style="background: #D97706" data-color="#D97706" title="Yellow 600"></div>
          <div class="color-swatch" style="background: #92400E" data-color="#92400E" title="Dark Yellow"></div>
          <div class="color-swatch" style="background: #D1FAE5" data-color="#D1FAE5" title="Light Green"></div>
          <div class="color-swatch" style="background: #A7F3D0" data-color="#A7F3D0" title="Green 200"></div>
          <div class="color-swatch" style="background: #34D399" data-color="#34D399" title="Green 400"></div>
          <div class="color-swatch" style="background: #10B981" data-color="#10B981" title="Green"></div>
          <div class="color-swatch" style="background: #059669" data-color="#059669" title="Green 600"></div>
          <div class="color-swatch" style="background: #065F46" data-color="#065F46" title="Dark Green"></div>
          <div class="color-swatch" style="background: #DBEAFE" data-color="#DBEAFE" title="Light Blue"></div>
          <div class="color-swatch" style="background: #BFDBFE" data-color="#BFDBFE" title="Blue 200"></div>
          <div class="color-swatch" style="background: #60A5FA" data-color="#60A5FA" title="Blue 400"></div>
          <div class="color-swatch" style="background: #3B82F6" data-color="#3B82F6" title="Blue"></div>
          <div class="color-swatch" style="background: #2563EB" data-color="#2563EB" title="Blue 600"></div>
          <div class="color-swatch" style="background: #1E40AF" data-color="#1E40AF" title="Dark Blue"></div>
          <div class="color-swatch" style="background: #EDE9FE" data-color="#EDE9FE" title="Light Purple"></div>
          <div class="color-swatch" style="background: #DDD6FE" data-color="#DDD6FE" title="Purple 200"></div>
          <div class="color-swatch" style="background: #A78BFA" data-color="#A78BFA" title="Purple 400"></div>
          <div class="color-swatch" style="background: #8B5CF6" data-color="#8B5CF6" title="Purple"></div>
          <div class="color-swatch" style="background: #7C3AED" data-color="#7C3AED" title="Purple 600"></div>
          <div class="color-swatch" style="background: #5B21B6" data-color="#5B21B6" title="Dark Purple"></div>
        </div>
      </div>
    </div>
    <div class="context-menu-item context-menu-submenu" data-action="text-color">
      <span class="icon">üî§</span>
      <span>Text Color</span>
      <div class="submenu">
        <div class="color-picker-grid" id="textColorPicker">
          <div class="color-swatch" style="background: #111827" data-color="#111827" title="Black"></div>
          <div class="color-swatch" style="background: #6B7280" data-color="#6B7280" title="Gray"></div>
          <div class="color-swatch" style="background: #EF4444" data-color="#EF4444" title="Red"></div>
          <div class="color-swatch" style="background: #F59E0B" data-color="#F59E0B" title="Orange"></div>
          <div class="color-swatch" style="background: #10B981" data-color="#10B981" title="Green"></div>
          <div class="color-swatch" style="background: #3B82F6" data-color="#3B82F6" title="Blue"></div>
          <div class="color-swatch" style="background: #8B5CF6" data-color="#8B5CF6" title="Purple"></div>
          <div class="color-swatch" style="background: #EC4899" data-color="#EC4899" title="Pink"></div>
          <div class="color-swatch" style="background: #DC2626" data-color="#DC2626" title="Dark Red"></div>
          <div class="color-swatch" style="background: #D97706" data-color="#D97706" title="Dark Orange"></div>
          <div class="color-swatch" style="background: #059669" data-color="#059669" title="Dark Green"></div>
          <div class="color-swatch" style="background: #2563EB" data-color="#2563EB" title="Dark Blue"></div>
        </div>
      </div>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="bold">
      <span class="icon"><b>B</b></span>
      <span>Bold</span>
      <span class="shortcut">Ctrl+B</span>
    </div>
    <div class="context-menu-item" data-action="italic">
      <span class="icon"><i>I</i></span>
      <span>Italic</span>
      <span class="shortcut">Ctrl+I</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="add-comment">
      <span class="icon">üí¨</span>
      <span>Add Comment</span>
    </div>
    <div class="context-menu-item" data-action="edit-comment" style="display: none;">
      <span class="icon">‚úèÔ∏è</span>
      <span>Edit Comment</span>
    </div>
    <div class="context-menu-item" data-action="delete-comment" style="display: none;">
      <span class="icon">üóëÔ∏è</span>
      <span>Delete Comment</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="clear">
      <span class="icon">üßπ</span>
      <span>Clear Cell</span>
      <span class="shortcut">Del</span>
    </div>
  </div>

  <div class="comment-tooltip" id="commentTooltip">
    <div class="comment-tooltip-author"></div>
    <div class="comment-tooltip-text"></div>
  </div>


  <div class="filter-dropdown" id="filterDropdown">
    <div class="filter-dropdown-header">
      <span class="filter-dropdown-title">Filter Column</span>
      <button class="filter-dropdown-clear" id="filterClearBtn">Clear</button>
    </div>
    <div class="filter-search">
      <input type="text" placeholder="Search values..." id="filterSearchInput">
    </div>
    <div class="filter-options" id="filterOptions"></div>
    <div class="filter-dropdown-footer">
      <button class="secondary" id="filterCancelBtn">Cancel</button>
      <button class="primary" id="filterApplyBtn">Apply</button>
    </div>
  </div>

  <script type="module">
    import {
      Workbook,
      workbookToXlsxBlob,
      xlsxBlobToWorkbook,
      csvToWorkbook,
      sheetToCsv,
    } from 'cellify';

    window.Workbook = Workbook;
    window.workbookToXlsxBlob = workbookToXlsxBlob;
    window.xlsxBlobToWorkbook = xlsxBlobToWorkbook;
    window.csvToWorkbook = csvToWorkbook;
    window.sheetToCsv = sheetToCsv;

    window.currentWorkbook = null;
    window.currentSheetIndex = 0;

    
    function log(message, type = '') {
      const logEl = document.getElementById('log');
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }
    window.log = log;

    log('Cellify loaded successfully', 'success');

    
    function download(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    window.download = download;

    
    function exportBasicExample() {
      log('Creating basic example...');

      const workbook = new Workbook();
      workbook.title = 'Basic Example';

      const sheet = workbook.addSheet('Data');

      
      sheet.cell('A1').value = 'Name';
      sheet.cell('B1').value = 'Age';
      sheet.cell('C1').value = 'City';

      
      const data = [
        ['Alice', 28, 'New York'],
        ['Bob', 34, 'San Francisco'],
        ['Charlie', 22, 'Chicago'],
        ['Diana', 31, 'Boston'],
      ];

      data.forEach((row, i) => {
        row.forEach((value, j) => {
          sheet.cell(i + 1, j).value = value;
        });
      });

      const blob = workbookToXlsxBlob(workbook);
      download(blob, 'basic-example.xlsx');
      log('Downloaded basic-example.xlsx', 'success');
    }

    function exportStyledExample() {
      log('Creating styled example...');

      const workbook = new Workbook();
      workbook.title = 'Styled Report';
      workbook.author = 'Cellify Demo';

      const sheet = workbook.addSheet('Sales Report');

      
      sheet.cell('A1').value = 'Q4 2024 Sales Report';
      sheet.cell('A1').style = {
        font: { bold: true, size: 18, color: '#FFFFFF' },
        fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#2F5496' },
        alignment: { horizontal: 'center' },
      };
      sheet.mergeCells('A1:D1');

      
      const headers = ['Product', 'Units', 'Price', 'Revenue'];
      headers.forEach((header, i) => {
        const cell = sheet.cell(2, i);
        cell.value = header;
        cell.style = {
          font: { bold: true, color: '#FFFFFF' },
          fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#4472C4' },
          alignment: { horizontal: 'center' },
          borders: {
            bottom: { style: 'medium', color: '#000000' },
          },
        };
      });

      
      const data = [
        ['Laptop Pro', 150, 1299.99, 194998.50],
        ['Wireless Mouse', 500, 49.99, 24995.00],
        ['Mechanical Keyboard', 300, 129.99, 38997.00],
        ['USB-C Hub', 450, 79.99, 35995.50],
        ['Monitor 27"', 200, 399.99, 79998.00],
      ];

      data.forEach((row, i) => {
        row.forEach((value, j) => {
          const cell = sheet.cell(i + 3, j);
          cell.value = value;
          if (j >= 2) {
            cell.style = {
              numberFormat: { formatCode: '#,##0.00' },
            };
          }
        });
      });

      
      sheet.cell('A8').value = 'Total';
      sheet.cell('A8').style = { font: { bold: true } };
      sheet.cell('D8').value = 374984.00;
      sheet.cell('D8').style = {
        font: { bold: true },
        numberFormat: { formatCode: '#,##0.00' },
        fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#E2EFDA' },
      };

      
      sheet.setColumnWidth(0, 20);
      sheet.setColumnWidth(1, 10);
      sheet.setColumnWidth(2, 12);
      sheet.setColumnWidth(3, 15);

      
      sheet.freeze(3, 0);

      const blob = workbookToXlsxBlob(workbook);
      download(blob, 'styled-report.xlsx');
      log('Downloaded styled-report.xlsx', 'success');
    }

    function exportFormulaExample() {
      log('Creating formula example...');

      const workbook = new Workbook();
      const sheet = workbook.addSheet('Calculations');

      
      sheet.cell('A1').value = 'Item';
      sheet.cell('B1').value = 'Quantity';
      sheet.cell('C1').value = 'Price';
      sheet.cell('D1').value = 'Total';

      
      for (let i = 0; i < 4; i++) {
        sheet.cell(0, i).style = {
          font: { bold: true },
          fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#D9E2F3' },
        };
      }

      
      const items = [
        ['Widget A', 10, 25.00],
        ['Widget B', 5, 50.00],
        ['Widget C', 20, 15.00],
      ];

      items.forEach((item, i) => {
        sheet.cell(i + 1, 0).value = item[0];
        sheet.cell(i + 1, 1).value = item[1];
        sheet.cell(i + 1, 2).value = item[2];
        sheet.cell(i + 1, 3).setFormula(`B${i + 2}*C${i + 2}`);
      });

      
      sheet.cell('A5').value = 'Grand Total:';
      sheet.cell('A5').style = { font: { bold: true } };
      sheet.cell('D5').setFormula('SUM(D2:D4)');
      sheet.cell('D5').style = {
        font: { bold: true },
        fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#C6EFCE' },
      };

      
      sheet.setColumnWidth(0, 15);
      sheet.setColumnWidth(1, 12);
      sheet.setColumnWidth(2, 12);
      sheet.setColumnWidth(3, 12);

      const blob = workbookToXlsxBlob(workbook);
      download(blob, 'formulas.xlsx');
      log('Downloaded formulas.xlsx (open in Excel to see calculated values)', 'success');
    }

    function exportMultiSheetExample() {
      log('Creating multi-sheet example...');

      const workbook = new Workbook();
      workbook.title = 'Multi-Sheet Workbook';

      
      const summary = workbook.addSheet('Summary');
      summary.cell('A1').value = 'Department Summary';
      summary.cell('A1').style = { font: { bold: true, size: 16 } };
      summary.mergeCells('A1:C1');

      summary.cell('A3').value = 'Department';
      summary.cell('B3').value = 'Employees';
      summary.cell('C3').value = 'Budget';

      const depts = [
        ['Engineering', 50, 5000000],
        ['Marketing', 25, 2000000],
        ['Sales', 40, 3000000],
        ['HR', 10, 500000],
      ];

      depts.forEach((d, i) => {
        summary.cell(i + 3, 0).value = d[0];
        summary.cell(i + 3, 1).value = d[1];
        summary.cell(i + 3, 2).value = d[2];
      });

      
      const eng = workbook.addSheet('Engineering');
      eng.cell('A1').value = 'Engineering Team';
      eng.cell('A1').style = { font: { bold: true } };

      
      const mkt = workbook.addSheet('Marketing');
      mkt.cell('A1').value = 'Marketing Team';
      mkt.cell('A1').style = { font: { bold: true } };

      const blob = workbookToXlsxBlob(workbook);
      download(blob, 'multi-sheet.xlsx');
      log('Downloaded multi-sheet.xlsx', 'success');
    }

    function exportCommentsExample() {
      log('Creating comments example...');

      const workbook = new Workbook();
      workbook.title = 'Comments Example';

      const sheet = workbook.addSheet('Reviews');

      
      const headers = ['Product', 'Rating', 'Reviewer', 'Status'];
      headers.forEach((header, i) => {
        const cell = sheet.cell(0, i);
        cell.value = header;
        cell.style = {
          font: { bold: true, color: '#FFFFFF' },
          fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#059669' },
          alignment: { horizontal: 'center' },
        };
      });

      
      const reviews = [
        { product: 'Laptop Pro', rating: 5, reviewer: 'Alice', status: 'Approved', comment: 'Excellent product! Fast shipping and great quality.' },
        { product: 'Wireless Mouse', rating: 4, reviewer: 'Bob', status: 'Pending', comment: 'Good mouse but battery drains quickly. Needs follow-up.' },
        { product: 'USB Hub', rating: 3, reviewer: 'Charlie', status: 'Flagged', comment: 'Product received damaged. Customer requesting refund.' },
      ];

      reviews.forEach((review, i) => {
        const row = i + 1;
        sheet.cell(row, 0).value = review.product;

        const ratingCell = sheet.cell(row, 1);
        ratingCell.value = review.rating;
        ratingCell.setComment(`Rating: ${review.rating}/5 stars`, review.reviewer);

        sheet.cell(row, 2).value = review.reviewer;

        const statusCell = sheet.cell(row, 3);
        statusCell.value = review.status;
        statusCell.setComment(review.comment, 'System');

        if (review.status === 'Approved') {
          statusCell.style = { fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#D1FAE5' } };
        } else if (review.status === 'Flagged') {
          statusCell.style = { fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#FEE2E2' } };
        } else {
          statusCell.style = { fill: { type: 'pattern', pattern: 'solid', foregroundColor: '#FEF3C7' } };
        }
      });

      sheet.setColumnWidth(0, 18);
      sheet.setColumnWidth(1, 10);
      sheet.setColumnWidth(2, 12);
      sheet.setColumnWidth(3, 12);

      const blob = workbookToXlsxBlob(workbook);
      download(blob, 'with-comments.xlsx');
      log('Downloaded with-comments.xlsx (hover over cells to see comments)', 'success');
    }

    
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    async function handleFile(file) {
      log(`Importing ${file.name}...`, 'info');

      try {
        let result;

        const lowerName = file.name.toLowerCase();
        if (lowerName.endsWith('.xlsx')) {
          result = await xlsxBlobToWorkbook(file);
        } else if (lowerName.endsWith('.csv')) {
          const text = await file.text();
          result = { workbook: csvToWorkbook(text), stats: { sheetCount: 1 }, warnings: [] };
        } else {
          throw new Error('Unsupported file type. Please use .xlsx or .csv');
        }

        window.currentWorkbook = result.workbook;
        window.currentSheetIndex = 0;
        undoStack.length = 0;
        activeFilters = {};
        clipboard = null;

        displayImportResult(result);
        log(`Successfully imported ${file.name}`, 'success');
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    function displayImportResult(result) {
      const { workbook, stats, warnings } = result;

      document.getElementById('importStats').style.display = 'block';

      
      let statsHtml = `
        <div class="stat-item">
          <div class="stat-value">${workbook.sheetCount}</div>
          <div class="stat-label">Sheets</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${(stats.totalCells || 0).toLocaleString()}</div>
          <div class="stat-label">Total Cells</div>
        </div>
      `;
      if (stats.formulaCells) {
        statsHtml += `
          <div class="stat-item">
            <div class="stat-value">${stats.formulaCells.toLocaleString()}</div>
            <div class="stat-label">Formulas</div>
          </div>
        `;
      }
      if (stats.mergedRanges) {
        statsHtml += `
          <div class="stat-item">
            <div class="stat-value">${stats.mergedRanges}</div>
            <div class="stat-label">Merged</div>
          </div>
        `;
      }
      if (stats.durationMs) {
        statsHtml += `
          <div class="stat-item">
            <div class="stat-value">${stats.durationMs}ms</div>
            <div class="stat-label">Import Time</div>
          </div>
        `;
      }
      document.getElementById('statsContent').innerHTML = statsHtml;

      
      const warningsEl = document.getElementById('warningsContent');
      if (warnings && warnings.length > 0) {
        warningsEl.style.display = 'block';
        warningsEl.innerHTML = `
          <p class="warnings-title">‚ö†Ô∏è Warnings</p>
          <ul>${warnings.map(w => `<li>${w.message}</li>`).join('')}</ul>
        `;
      } else {
        warningsEl.style.display = 'none';
      }

      
      const tabsEl = document.getElementById('sheetTabs');
      tabsEl.innerHTML = workbook.sheets.map((sheet, i) =>
        `<button class="sheet-tab ${i === 0 ? 'active' : ''}" data-sheet-index="${i}">${sheet.name}</button>`
      ).join('');

      
      tabsEl.querySelectorAll('.sheet-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          selectSheet(parseInt(tab.dataset.sheetIndex));
        });
      });

      
      displaySheet(workbook.sheets[0]);
    }

    function selectSheet(index) {
      window.currentSheetIndex = index;
      const sheet = window.currentWorkbook.sheets[index];

      
      undoStack.length = 0;
      activeFilters = {};

      
      document.querySelectorAll('.sheet-tab').forEach((tab, i) => {
        tab.classList.toggle('active', i === index);
      });

      displaySheet(sheet);
    }

    function displaySheet(sheet) {
      const dims = sheet.dimensions;

      if (!dims) {
        document.getElementById('preview').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>This sheet is empty</p>
          </div>
        `;
        return;
      }

      
      const rowsToShow = Math.min(dims.endRow - dims.startRow + 1, 50);
      const colsToShow = Math.min(dims.endCol - dims.startCol + 1, 20);

      const mergeStarts = new Map(); 
      const coveredCells = new Set(); 

      for (const merge of (sheet.merges || [])) {
        const rowSpan = merge.endRow - merge.startRow + 1;
        const colSpan = merge.endCol - merge.startCol + 1;
        const key = `${merge.startRow},${merge.startCol}`;
        mergeStarts.set(key, { rowSpan, colSpan });

        for (let r = merge.startRow; r <= merge.endRow; r++) {
          for (let c = merge.startCol; c <= merge.endCol; c++) {
            if (r !== merge.startRow || c !== merge.startCol) {
              coveredCells.add(`${r},${c}`);
            }
          }
        }
      }

      let html = '<table id="previewTable"><colgroup><col style="width:50px">';
      for (let c = dims.startCol; c < dims.startCol + colsToShow; c++) {
        html += `<col style="width:120px" data-col="${c}">`;
      }
      html += '</colgroup><thead><tr><th></th>';

      
      for (let c = dims.startCol; c < dims.startCol + colsToShow; c++) {
        html += `<th data-col="${c}">${columnLetter(c)}<button class="filter-btn" data-col="${c}" title="Filter column">‚ñº</button><span class="resize-handle" data-col="${c}"></span></th>`;
      }
      html += '</tr></thead><tbody>';

      
      for (let r = dims.startRow; r < dims.startRow + rowsToShow; r++) {
        html += `<tr data-row="${r}"><th>${r + 1}<span class="row-resize-handle" data-row="${r}"></span></th>`;
        for (let c = dims.startCol; c < dims.startCol + colsToShow; c++) {
          const cellKey = `${r},${c}`;

          if (coveredCells.has(cellKey)) {
            continue;
          }

          const cell = sheet.getCell(r, c);
          let value = cell?.value ?? '';

          
          if (value instanceof Date) {
            value = value.toLocaleDateString();
          } else if (typeof value === 'number') {
            value = value.toLocaleString();
          }

          
          const formula = cell?.formula;
          const comment = cell?.comment;
          let titleParts = [];
          if (formula) titleParts.push(`Formula: =${escapeHtml(formula.formula)}`);
          if (comment) {
            const commentText = typeof comment.text === 'string' ? comment.text : comment.text.plainText || '';
            titleParts.push(`Comment: ${escapeHtml(commentText)}${comment.author ? ` - ${escapeHtml(comment.author)}` : ''}`);
          }
          let title = titleParts.join('\n');
          let style = cellStyleToCss(cell?.style);
          let cssClass = comment ? 'has-comment' : '';

          
          if (formula && !cell?.style?.font?.color) {
            style += 'color: #059669; font-style: italic;';
          }

          
          const mergeInfo = mergeStarts.get(cellKey);
          let spanAttrs = '';
          if (mergeInfo) {
            if (mergeInfo.rowSpan > 1) spanAttrs += ` rowspan="${mergeInfo.rowSpan}"`;
            if (mergeInfo.colSpan > 1) spanAttrs += ` colspan="${mergeInfo.colSpan}"`;
          }

          html += `<td${spanAttrs} data-row="${r}" data-col="${c}" title="${title}" style="${style}" class="${cssClass}">${escapeHtml(String(value))}</td>`;
        }
        html += '</tr>';
      }

      html += '</tbody></table>';

      const totalRows = dims.endRow - dims.startRow + 1;
      const totalCols = dims.endCol - dims.startCol + 1;
      if (totalRows > rowsToShow || totalCols > colsToShow) {
        html += `<div class="preview-info">
          Showing ${rowsToShow} of ${totalRows.toLocaleString()} rows, ${colsToShow} of ${totalCols.toLocaleString()} columns
        </div>`;
      }

      html += `<div class="edit-hint">
        <kbd>Click</kbd> select ¬∑ <kbd>Double-click</kbd>/<kbd>Enter</kbd> edit ¬∑ <kbd>Right-click</kbd> menu ¬∑ <kbd>Ctrl+C/X/V</kbd> copy/cut/paste ¬∑ <kbd>Ctrl+B/I</kbd> bold/italic ¬∑ <kbd>Ctrl+Z</kbd> undo ¬∑ <kbd>Del</kbd> clear
      </div>`;

      document.getElementById('preview').innerHTML = html;
      initResizeHandlers();
      initCellEditHandlers();
    }

    function initResizeHandlers() {
      const preview = document.getElementById('preview');
      const table = document.getElementById('previewTable');
      if (!table) return;

      
      if (window.resizeListeners) {
        preview.removeEventListener('mousedown', window.resizeListeners.previewMouseDown);
        document.removeEventListener('mousemove', window.resizeListeners.docMouseMove);
        document.removeEventListener('mouseup', window.resizeListeners.docMouseUp);
      }

      let isResizing = false;
      let currentCol = null;
      let currentRow = null;
      let startX = 0;
      let startY = 0;
      let startWidth = 0;
      let startHeight = 0;

      
      const previewMouseDown = (e) => {
        if (e.target.classList.contains('resize-handle')) {
          isResizing = true;
          currentCol = e.target.dataset.col;
          startX = e.pageX;
          const colEl = table.querySelector(`colgroup col[data-col="${currentCol}"]`);
          startWidth = colEl ? parseInt(colEl.style.width) || 120 : 120;
          e.target.classList.add('resizing');
          document.body.classList.add('col-resizing');
          e.preventDefault();
        } else if (e.target.classList.contains('row-resize-handle')) {
          isResizing = true;
          currentRow = e.target.dataset.row;
          startY = e.pageY;
          const rowEl = table.querySelector(`tr[data-row="${currentRow}"]`);
          startHeight = rowEl ? rowEl.offsetHeight : 30;
          e.target.classList.add('resizing');
          document.body.classList.add('row-resizing');
          e.preventDefault();
        }
      };

      const docMouseMove = (e) => {
        if (!isResizing) return;

        if (currentCol !== null) {
          const diff = e.pageX - startX;
          const newWidth = Math.max(60, startWidth + diff);
          const colEl = table.querySelector(`colgroup col[data-col="${currentCol}"]`);
          if (colEl) {
            colEl.style.width = newWidth + 'px';
          }
        }

        if (currentRow !== null) {
          const diff = e.pageY - startY;
          const newHeight = Math.max(25, startHeight + diff);
          const rowEl = table.querySelector(`tr[data-row="${currentRow}"]`);
          if (rowEl) {
            rowEl.style.height = newHeight + 'px';
          }
        }
      };

      const docMouseUp = () => {
        if (isResizing) {
          isResizing = false;
          document.body.classList.remove('col-resizing', 'row-resizing');
          document.querySelectorAll('.resize-handle.resizing, .row-resize-handle.resizing').forEach(el => {
            el.classList.remove('resizing');
          });
          currentCol = null;
          currentRow = null;
        }
      };

      preview.addEventListener('mousedown', previewMouseDown);
      document.addEventListener('mousemove', docMouseMove);
      document.addEventListener('mouseup', docMouseUp);

      
      window.resizeListeners = { previewMouseDown, docMouseMove, docMouseUp };
    }

    let selectedRow = null;
    let selectedCol = null;
    let isEditing = false;

    let selectedColumn = null;  // Column index when whole column is selected
    let selectedRowHeader = null;  // Row index when whole row is selected

    const undoStack = [];
    const MAX_UNDO_STACK = 50;

    
    let clipboard = null;  

    
    const contextMenu = document.getElementById('contextMenu');
    const commentTooltip = document.getElementById('commentTooltip');
    let contextMenuRow = null;
    let contextMenuCol = null;

    function showContextMenu(e, row, col) {
      e.preventDefault();
      contextMenuRow = row;
      contextMenuCol = col;

      
      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.getCell(row, col);
      const hasComment = cell?.comment;

      
      const addCommentItem = contextMenu.querySelector('[data-action="add-comment"]');
      const editCommentItem = contextMenu.querySelector('[data-action="edit-comment"]');
      const deleteCommentItem = contextMenu.querySelector('[data-action="delete-comment"]');

      if (hasComment) {
        addCommentItem.style.display = 'none';
        editCommentItem.style.display = 'flex';
        deleteCommentItem.style.display = 'flex';
      } else {
        addCommentItem.style.display = 'flex';
        editCommentItem.style.display = 'none';
        deleteCommentItem.style.display = 'none';
      }

      
      const pasteItem = contextMenu.querySelector('[data-action="paste"]');
      if (clipboard) {
        pasteItem.classList.remove('disabled');
      } else {
        pasteItem.classList.add('disabled');
      }

      
      const x = e.clientX;
      const y = e.clientY;

      contextMenu.style.left = x + 'px';
      contextMenu.style.top = y + 'px';
      contextMenu.classList.add('visible');

      
      const rect = contextMenu.getBoundingClientRect();
      if (rect.right > window.innerWidth) {
        contextMenu.style.left = (x - rect.width) + 'px';
      }
      if (rect.bottom > window.innerHeight) {
        contextMenu.style.top = (y - rect.height) + 'px';
      }

      
      selectCell(row, col);
    }

    function hideContextMenu() {
      contextMenu.classList.remove('visible');
      contextMenuRow = null;
      contextMenuCol = null;
    }

    
    document.addEventListener('click', (e) => {
      if (!contextMenu.contains(e.target)) {
        hideContextMenu();
      }
    });

    
    document.addEventListener('scroll', hideContextMenu, true);

    
    contextMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.context-menu-item');
      if (!item || item.classList.contains('disabled')) return;

      const action = item.dataset.action;
      if (!action) return;

      switch (action) {
        case 'copy':
          copyCell();
          break;
        case 'cut':
          cutCell();
          break;
        case 'paste':
          pasteCell();
          break;
        case 'bold':
          toggleBold();
          break;
        case 'italic':
          toggleItalic();
          break;
        case 'add-comment':
        case 'edit-comment':
          showCommentDialog();
          break;
        case 'delete-comment':
          deleteComment();
          break;
        case 'clear':
          clearCell();
          break;
      }

      hideContextMenu();
    });

    
    document.getElementById('fillColorPicker').addEventListener('click', (e) => {
      const swatch = e.target.closest('.color-swatch');
      if (!swatch) return;

      const color = swatch.dataset.color;
      setFillColor(color);
      hideContextMenu();
    });

    document.getElementById('textColorPicker').addEventListener('click', (e) => {
      const swatch = e.target.closest('.color-swatch');
      if (!swatch) return;

      const color = swatch.dataset.color;
      setTextColor(color);
      hideContextMenu();
    });

    
    function copyCell() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.getCell(selectedRow, selectedCol);

      clipboard = {
        row: selectedRow,
        col: selectedCol,
        value: cell?.value,
        formula: cell?.formula?.formula,
        style: cell?.style ? JSON.parse(JSON.stringify(cell.style)) : null,
        comment: cell?.comment ? JSON.parse(JSON.stringify(cell.comment)) : null,
        isCut: false
      };

      log(`Copied cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    
    function cutCell() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.getCell(selectedRow, selectedCol);

      clipboard = {
        row: selectedRow,
        col: selectedCol,
        value: cell?.value,
        formula: cell?.formula?.formula,
        style: cell?.style ? JSON.parse(JSON.stringify(cell.style)) : null,
        comment: cell?.comment ? JSON.parse(JSON.stringify(cell.comment)) : null,
        isCut: true
      };

      
      const td = document.querySelector(`td[data-row="${selectedRow}"][data-col="${selectedCol}"]`);
      if (td) {
        td.style.opacity = '0.5';
        td.style.border = '2px dashed var(--primary)';
      }

      log(`Cut cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    
    function pasteCell() {
      if (!clipboard || selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);
      const oldValue = cell.value;

      
      undoStack.push({ row: selectedRow, col: selectedCol, oldValue, newValue: clipboard.value });
      if (undoStack.length > MAX_UNDO_STACK) undoStack.shift();

      
      if (clipboard.formula) {
        cell.setFormula(clipboard.formula);
      } else if (clipboard.value !== undefined && clipboard.value !== null) {
        cell.value = clipboard.value;
      }

      
      if (clipboard.style) {
        cell.style = JSON.parse(JSON.stringify(clipboard.style));
      }

      if (clipboard.comment) {
        const text = typeof clipboard.comment.text === 'string'
          ? clipboard.comment.text
          : clipboard.comment.text?.plainText || '';
        cell.setComment(text, clipboard.comment.author);
      }

      if (clipboard.isCut) {
        const sourceSheet = window.currentWorkbook.sheets[window.currentSheetIndex];
        const sourceCell = sourceSheet.cell(clipboard.row, clipboard.col);
        sourceCell.clear();

        const sourceTd = document.querySelector(`td[data-row="${clipboard.row}"][data-col="${clipboard.col}"]`);
        if (sourceTd) {
          sourceTd.textContent = '';
          sourceTd.style.opacity = '';
          sourceTd.style.border = '';
          sourceTd.style.backgroundColor = '';
          sourceTd.classList.remove('has-comment');
        }

        clipboard = null;
      }

      updateCellDisplay(selectedRow, selectedCol);
      log(`Pasted to cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    function setFillColor(color) {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);

      if (!cell.style) cell.style = {};

      if (color) {
        cell.style.fill = {
          type: 'pattern',
          pattern: 'solid',
          foregroundColor: color
        };
      } else {
        delete cell.style.fill;
      }

      updateCellDisplay(selectedRow, selectedCol);
      log(`Set fill color to ${color || 'none'} for cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    function setTextColor(color) {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);

      if (!cell.style) cell.style = {};
      if (!cell.style.font) cell.style.font = {};

      cell.style.font.color = color;

      updateCellDisplay(selectedRow, selectedCol);
      log(`Set text color to ${color} for cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    function toggleBold() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);

      if (!cell.style) cell.style = {};
      if (!cell.style.font) cell.style.font = {};

      cell.style.font.bold = !cell.style.font.bold;

      updateCellDisplay(selectedRow, selectedCol);
      log(`${cell.style.font.bold ? 'Added' : 'Removed'} bold for cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    function toggleItalic() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);

      if (!cell.style) cell.style = {};
      if (!cell.style.font) cell.style.font = {};

      cell.style.font.italic = !cell.style.font.italic;

      updateCellDisplay(selectedRow, selectedCol);
      log(`${cell.style.font.italic ? 'Added' : 'Removed'} italic for cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    function showCommentDialog() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.getCell(selectedRow, selectedCol);
      const existingComment = cell?.comment;

      let currentText = '';
      let currentAuthor = '';
      if (existingComment) {
        currentText = typeof existingComment.text === 'string'
          ? existingComment.text
          : existingComment.text?.plainText || '';
        currentAuthor = existingComment.author || '';
      }

      const text = prompt('Enter comment:', currentText);
      if (text === null) return; 

      if (text.trim() === '') {
        deleteComment();
        return;
      }

      const author = prompt('Author (optional):', currentAuthor) || undefined;

      const targetCell = sheet.cell(selectedRow, selectedCol);
      targetCell.setComment(text, author);

      updateCellDisplay(selectedRow, selectedCol);
      log(`${existingComment ? 'Updated' : 'Added'} comment for cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    
    function deleteComment() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);

      if (cell.comment) {
        cell.comment = undefined;
        updateCellDisplay(selectedRow, selectedCol);
        log(`Deleted comment from cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
      }
    }

    
    function clearCell() {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(selectedRow, selectedCol);
      const oldValue = cell.value;

      
      undoStack.push({ row: selectedRow, col: selectedCol, oldValue, newValue: null });
      if (undoStack.length > MAX_UNDO_STACK) undoStack.shift();

      cell.clear();
      updateCellDisplay(selectedRow, selectedCol);
      log(`Cleared cell ${columnLetter(selectedCol)}${selectedRow + 1}`, 'info');
    }

    
    function updateCellDisplay(row, col) {
      const td = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
      if (!td) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.getCell(row, col);

      
      let displayValue = '';
      if (cell?.value instanceof Date) {
        displayValue = cell.value.toLocaleDateString();
      } else if (cell?.value !== undefined && cell?.value !== null) {
        displayValue = typeof cell.value === 'number' ? cell.value.toLocaleString() : String(cell.value);
      }
      td.textContent = displayValue;

      
      td.style.cssText = cellStyleToCss(cell?.style);

      
      if (cell?.formula && !cell?.style?.font?.color) {
        td.style.color = '#059669';
        td.style.fontStyle = 'italic';
      }

      
      if (cell?.comment) {
        td.classList.add('has-comment');
        const commentText = typeof cell.comment.text === 'string'
          ? cell.comment.text
          : cell.comment.text?.plainText || '';
        let titleParts = [];
        if (cell.formula) titleParts.push(`Formula: =${escapeHtml(cell.formula.formula)}`);
        titleParts.push(`Comment: ${escapeHtml(commentText)}${cell.comment.author ? ` - ${escapeHtml(cell.comment.author)}` : ''}`);
        td.title = titleParts.join('\n');
      } else {
        td.classList.remove('has-comment');
        if (cell?.formula) {
          td.title = `Formula: =${escapeHtml(cell.formula.formula)}`;
        } else {
          td.title = '';
        }
      }

      td.classList.add('modified');
    }

    
    function showCommentTooltip(e, cell) {
      if (!cell?.comment) return;

      const commentText = typeof cell.comment.text === 'string'
        ? cell.comment.text
        : cell.comment.text?.plainText || '';

      const authorEl = commentTooltip.querySelector('.comment-tooltip-author');
      const textEl = commentTooltip.querySelector('.comment-tooltip-text');

      authorEl.textContent = cell.comment.author || 'Comment';
      textEl.textContent = commentText;

      commentTooltip.style.left = (e.clientX + 10) + 'px';
      commentTooltip.style.top = (e.clientY + 10) + 'px';
      commentTooltip.classList.add('visible');
    }

    function hideCommentTooltip() {
      commentTooltip.classList.remove('visible');
    }

    
    const filterDropdown = document.getElementById('filterDropdown');
    const filterSearchInput = document.getElementById('filterSearchInput');
    const filterOptions = document.getElementById('filterOptions');
    let activeFilters = {}; 
    let currentFilterCol = null;
    let currentFilterValues = new Map(); 
    let pendingFilterSelections = new Set();

    function showFilterDropdown(e, colIndex) {
      e.stopPropagation();
      currentFilterCol = colIndex;

      
      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const dims = sheet.dimensions;
      if (!dims) return;

      currentFilterValues.clear();
      const rowsToShow = Math.min(dims.endRow - dims.startRow + 1, 50);

      for (let r = dims.startRow; r < dims.startRow + rowsToShow; r++) {
        const cell = sheet.getCell(r, colIndex);
        let value = cell?.value;

        if (value instanceof Date) {
          value = value.toLocaleDateString();
        } else if (value === null || value === undefined) {
          value = '(Empty)';
        } else {
          value = String(value);
        }

        currentFilterValues.set(value, (currentFilterValues.get(value) || 0) + 1);
      }

      
      if (activeFilters[colIndex]) {
        pendingFilterSelections = new Set(activeFilters[colIndex]);
      } else {
        pendingFilterSelections = new Set(currentFilterValues.keys());
      }

      
      renderFilterOptions('');

      
      const btn = e.target;
      const rect = btn.getBoundingClientRect();
      filterDropdown.style.left = Math.min(rect.left, window.innerWidth - 250) + 'px';
      filterDropdown.style.top = (rect.bottom + 5) + 'px';
      filterDropdown.classList.add('visible');

      
      filterSearchInput.value = '';
      filterSearchInput.focus();

      
      filterDropdown.querySelector('.filter-dropdown-title').textContent =
        `Filter: ${columnLetter(colIndex)}`;
    }

    function renderFilterOptions(searchTerm) {
      const search = searchTerm.toLowerCase();
      let html = '';

      
      const sortedValues = Array.from(currentFilterValues.entries())
        .filter(([value]) => value.toLowerCase().includes(search))
        .sort((a, b) => a[0].localeCompare(b[0]));

      
      const allSelected = sortedValues.every(([value]) => pendingFilterSelections.has(value));
      html += `
        <div class="filter-option" data-value="__select_all__">
          <input type="checkbox" ${allSelected ? 'checked' : ''}>
          <span class="filter-option-label">(Select All)</span>
        </div>
      `;

      for (const [value, count] of sortedValues) {
        const checked = pendingFilterSelections.has(value) ? 'checked' : '';
        html += `
          <div class="filter-option" data-value="${escapeHtml(value)}">
            <input type="checkbox" ${checked}>
            <span class="filter-option-label">${escapeHtml(value)}</span>
            <span class="filter-option-count">(${count})</span>
          </div>
        `;
      }

      filterOptions.innerHTML = html;
    }

    function hideFilterDropdown() {
      filterDropdown.classList.remove('visible');
      currentFilterCol = null;
    }

    function applyFilter() {
      if (currentFilterCol === null) return;

      
      if (pendingFilterSelections.size === currentFilterValues.size) {
        delete activeFilters[currentFilterCol];
      } else {
        activeFilters[currentFilterCol] = new Set(pendingFilterSelections);
      }

      applyAllFilters();
      updateFilterButtonStates();
      hideFilterDropdown();

      const count = Object.keys(activeFilters).length;
      if (count > 0) {
        log(`Applied filter on column ${columnLetter(currentFilterCol)} (${count} active filter${count > 1 ? 's' : ''})`, 'info');
      } else {
        log('All filters cleared', 'info');
      }
    }

    function clearCurrentFilter() {
      if (currentFilterCol === null) return;
      pendingFilterSelections = new Set(currentFilterValues.keys());
      renderFilterOptions(filterSearchInput.value);
    }

    function applyAllFilters() {
      const table = document.getElementById('previewTable');
      if (!table) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const tbody = table.querySelector('tbody');
      const rows = tbody.querySelectorAll('tr');

      rows.forEach(tr => {
        const rowIndex = parseInt(tr.dataset.row);
        let visible = true;

        
        for (const [colIndex, allowedValues] of Object.entries(activeFilters)) {
          const cell = sheet.getCell(rowIndex, parseInt(colIndex));
          let value = cell?.value;

          if (value instanceof Date) {
            value = value.toLocaleDateString();
          } else if (value === null || value === undefined) {
            value = '(Empty)';
          } else {
            value = String(value);
          }

          if (!allowedValues.has(value)) {
            visible = false;
            break;
          }
        }

        if (visible) {
          tr.classList.remove('filtered-out');
        } else {
          tr.classList.add('filtered-out');
        }
      });
    }

    function updateFilterButtonStates() {
      const table = document.getElementById('previewTable');
      if (!table) return;

      const filterBtns = table.querySelectorAll('th .filter-btn');
      filterBtns.forEach(btn => {
        const col = parseInt(btn.dataset.col);
        if (activeFilters[col]) {
          btn.classList.add('active');
          btn.closest('th').classList.add('has-filter');
        } else {
          btn.classList.remove('active');
          btn.closest('th').classList.remove('has-filter');
        }
      });
    }

    function clearAllFilters() {
      activeFilters = {};
      applyAllFilters();
      updateFilterButtonStates();
      log('All filters cleared', 'info');
    }

    
    filterSearchInput.addEventListener('input', (e) => {
      renderFilterOptions(e.target.value);
    });

    filterOptions.addEventListener('click', (e) => {
      const option = e.target.closest('.filter-option');
      if (!option) return;

      const value = option.dataset.value;
      const checkbox = option.querySelector('input[type="checkbox"]');

      if (value === '__select_all__') {
        
        const search = filterSearchInput.value.toLowerCase();
        const visibleValues = Array.from(currentFilterValues.keys())
          .filter(v => v.toLowerCase().includes(search));

        if (checkbox.checked) {
          visibleValues.forEach(v => pendingFilterSelections.delete(v));
        } else {
          visibleValues.forEach(v => pendingFilterSelections.add(v));
        }
      } else {
        if (pendingFilterSelections.has(value)) {
          pendingFilterSelections.delete(value);
        } else {
          pendingFilterSelections.add(value);
        }
      }

      renderFilterOptions(filterSearchInput.value);
    });

    document.getElementById('filterApplyBtn').addEventListener('click', applyFilter);
    document.getElementById('filterCancelBtn').addEventListener('click', hideFilterDropdown);
    document.getElementById('filterClearBtn').addEventListener('click', clearCurrentFilter);

    
    document.addEventListener('click', (e) => {
      if (!filterDropdown.contains(e.target) && !e.target.closest('.filter-btn')) {
        hideFilterDropdown();
      }
    });

    

    function initCellEditHandlers() {
      const preview = document.getElementById('preview');
      const table = document.getElementById('previewTable');
      if (!table) return;

      
      if (window.cellEditListeners) {
        preview.removeEventListener('click', window.cellEditListeners.onClick);
        preview.removeEventListener('dblclick', window.cellEditListeners.onDblClick);
        preview.removeEventListener('contextmenu', window.cellEditListeners.onContextMenu);
        preview.removeEventListener('mousemove', window.cellEditListeners.onMouseMove);
        preview.removeEventListener('mouseleave', window.cellEditListeners.onMouseLeave);
        document.removeEventListener('keydown', window.cellEditListeners.onKeyDown);
      }

      
      selectedRow = null;
      selectedCol = null;
      isEditing = false;

      const onClick = (e) => {
        // Check if clicking on filter button (don't select column)
        if (e.target.closest('.filter-btn') || e.target.closest('.resize-handle') || e.target.closest('.row-resize-handle')) {
          return;
        }

        // Check for column header click (thead th with data-col)
        const colHeader = e.target.closest('thead th[data-col]');
        if (colHeader && window.currentWorkbook) {
          const col = parseInt(colHeader.dataset.col);
          selectColumn(col);
          return;
        }

        // Check for row header click (tbody th inside tr with data-row)
        const rowHeader = e.target.closest('tbody tr[data-row] th');
        if (rowHeader && window.currentWorkbook) {
          const tr = rowHeader.closest('tr[data-row]');
          if (tr) {
            const row = parseInt(tr.dataset.row);
            selectRow(row);
            return;
          }
        }

        // Regular cell click
        const td = e.target.closest('td[data-row][data-col]');
        if (td && !isEditing) {
          const row = parseInt(td.dataset.row);
          const col = parseInt(td.dataset.col);
          selectCell(row, col);
        }
      };

      const onDblClick = (e) => {
        const td = e.target.closest('td[data-row][data-col]');
        if (td) {
          const row = parseInt(td.dataset.row);
          const col = parseInt(td.dataset.col);
          selectCell(row, col);
          startEditing(row, col);
        }
      };

      const onContextMenu = (e) => {
        const td = e.target.closest('td[data-row][data-col]');
        if (td && window.currentWorkbook) {
          const row = parseInt(td.dataset.row);
          const col = parseInt(td.dataset.col);
          showContextMenu(e, row, col);
        }
      };

      const onMouseMove = (e) => {
        const td = e.target.closest('td[data-row][data-col]');
        if (td && td.classList.contains('has-comment')) {
          const row = parseInt(td.dataset.row);
          const col = parseInt(td.dataset.col);
          const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
          const cell = sheet.getCell(row, col);
          showCommentTooltip(e, cell);
        } else {
          hideCommentTooltip();
        }
      };

      const onMouseLeave = () => {
        hideCommentTooltip();
      };

      const onKeyDown = (e) => {
        handleCellKeyDown(e);
      };

      const onFilterClick = (e) => {
        const filterBtn = e.target.closest('.filter-btn');
        if (filterBtn && window.currentWorkbook) {
          const col = parseInt(filterBtn.dataset.col);
          showFilterDropdown(e, col);
        }
      };

      preview.addEventListener('click', onClick);
      preview.addEventListener('dblclick', onDblClick);
      preview.addEventListener('contextmenu', onContextMenu);
      preview.addEventListener('mousemove', onMouseMove);
      preview.addEventListener('mouseleave', onMouseLeave);
      document.addEventListener('keydown', onKeyDown);

      
      const filterBtns = preview.querySelectorAll('.filter-btn');
      filterBtns.forEach(btn => btn.addEventListener('click', onFilterClick));

      window.cellEditListeners = { onClick, onDblClick, onContextMenu, onMouseMove, onMouseLeave, onKeyDown, onFilterClick };
    }

    function clearAllSelections() {
      document.querySelectorAll('td.selected, td.col-selected, td.row-selected').forEach(el => {
        el.classList.remove('selected', 'col-selected', 'row-selected');
      });
      document.querySelectorAll('th.col-selected, th.row-selected').forEach(el => {
        el.classList.remove('col-selected', 'row-selected');
      });
      selectedColumn = null;
      selectedRowHeader = null;
    }

    function selectCell(row, col) {
      // Clear all selections
      clearAllSelections();

      // If clicking same cell while editing, don't change selection
      if (isEditing && row === selectedRow && col === selectedCol) {
        return;
      }

      // If editing another cell, save first
      if (isEditing) {
        const input = document.querySelector('td.editing input');
        if (input) {
          saveEdit(selectedRow, selectedCol, input.value);
        }
      }

      selectedRow = row;
      selectedCol = col;

      // Find and highlight the cell
      const td = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
      if (td) {
        td.classList.add('selected');
      }
    }

    function selectColumn(colIndex) {
      // Clear all selections first
      clearAllSelections();
      selectedColumn = colIndex;
      selectedRow = null;
      selectedCol = null;

      // Highlight column header
      const th = document.querySelector(`thead th[data-col="${colIndex}"]`);
      if (th) {
        th.classList.add('col-selected');
      }

      // Highlight all cells in the column
      document.querySelectorAll(`td[data-col="${colIndex}"]`).forEach(td => {
        td.classList.add('col-selected');
      });

      log(`Selected column ${columnLetter(colIndex)}`, 'info');
    }

    function selectRow(rowIndex) {
      // Clear all selections first
      clearAllSelections();
      selectedRowHeader = rowIndex;
      selectedRow = null;
      selectedCol = null;

      // Highlight row header
      const th = document.querySelector(`tbody tr[data-row="${rowIndex}"] th`);
      if (th) {
        th.classList.add('row-selected');
      }

      // Highlight all cells in the row
      document.querySelectorAll(`td[data-row="${rowIndex}"]`).forEach(td => {
        td.classList.add('row-selected');
      });

      log(`Selected row ${rowIndex + 1}`, 'info');
    }

    function startEditing(row, col) {
      if (isEditing) return;

      const td = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
      if (!td) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.getCell(row, col);

      
      let editValue = '';
      if (cell?.formula) {
        editValue = '=' + cell.formula.formula;
      } else if (cell?.value !== null && cell?.value !== undefined) {
        if (cell.value instanceof Date) {
          editValue = cell.value.toISOString().split('T')[0]; 
        } else {
          editValue = String(cell.value);
        }
      }

      isEditing = true;
      td.classList.add('editing');

      
      td.dataset.originalContent = td.innerHTML;

      
      const input = document.createElement('input');
      input.type = 'text';
      input.autocomplete = 'off';
      input.setAttribute('data-form-type', 'other');  
      input.value = editValue;
      td.innerHTML = '';
      td.appendChild(input);

      
      const minWidth = td.offsetWidth;
      const textWidth = getTextWidth(editValue, getComputedStyle(input).font);
      input.style.width = Math.max(minWidth, textWidth + 30) + 'px';

      input.focus();
      input.select();
      
      input.scrollLeft = 0;

      
      input.addEventListener('blur', () => {
        if (isEditing) {
          saveEdit(row, col, input.value);
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveEdit(row, col, input.value);
          
          moveSelection(1, 0);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelEdit(row, col);
        } else if (e.key === 'Tab') {
          e.preventDefault();
          saveEdit(row, col, input.value);
          moveSelection(0, e.shiftKey ? -1 : 1);
        }
      });
    }

    function saveEdit(row, col, newValue) {
      if (!isEditing) return;

      const td = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
      if (!td) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(row, col);
      const oldValue = cell.value;

      
      const parsed = parseInputValue(newValue);

      
      if (parsed.isFormula) {
        cell.setFormula(parsed.value);
        log(`Cell ${columnLetter(col)}${row + 1}: Set formula =${parsed.value}`, 'info');
      } else {
        cell.value = parsed.value;
        const displayOld = oldValue instanceof Date ? oldValue.toLocaleDateString() : oldValue;
        const displayNew = parsed.value instanceof Date ? parsed.value.toLocaleDateString() : parsed.value;
        if (displayOld !== displayNew) {
          log(`Cell ${columnLetter(col)}${row + 1}: "${displayOld}" ‚Üí "${displayNew}"`, 'info');
        }
      }

      
      undoStack.push({ row, col, oldValue, newValue: parsed.value, wasFormula: parsed.isFormula });
      if (undoStack.length > MAX_UNDO_STACK) {
        undoStack.shift(); 
      }

      
      isEditing = false;
      td.classList.remove('editing');

      let displayValue = '';
      if (cell.formula) {
        displayValue = cell.value !== null && cell.value !== undefined ? cell.value : '';
        td.style.color = '#059669';
        td.style.fontStyle = 'italic';
        td.style.fontWeight = '500';
        td.title = `Formula: =${escapeHtml(cell.formula.formula)}`;
      } else {
        if (cell.value instanceof Date) {
          displayValue = cell.value.toLocaleDateString();
        } else if (typeof cell.value === 'number') {
          displayValue = cell.value.toLocaleString();
        } else {
          displayValue = cell.value ?? '';
        }
        td.style.color = '';
        td.style.fontStyle = '';
        td.style.fontWeight = '';
        td.title = '';
      }

      td.textContent = String(displayValue);
      td.classList.add('modified');
      delete td.dataset.originalContent;
    }

    function cancelEdit(row, col) {
      if (!isEditing) return;

      const td = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
      if (!td) return;

      isEditing = false;
      td.classList.remove('editing');

      
      if (td.dataset.originalContent !== undefined) {
        td.innerHTML = td.dataset.originalContent;
        delete td.dataset.originalContent;
      }

      log(`Edit cancelled for cell ${columnLetter(col)}${row + 1}`, 'info');
    }

    function undoLastEdit() {
      if (undoStack.length === 0) {
        log('Nothing to undo', 'info');
        return;
      }

      const action = undoStack.pop();
      const { row, col, oldValue } = action;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const cell = sheet.cell(row, col);

      if (oldValue !== undefined && oldValue !== null) {
        
        if (cell.formula) {
          cell.clearFormula();
        }
        cell.value = oldValue;
      } else {
        cell.clear();
      }

      
      const td = document.querySelector(`td[data-row="${row}"][data-col="${col}"]`);
      if (td) {
        let displayValue = '';
        if (oldValue instanceof Date) {
          displayValue = oldValue.toLocaleDateString();
        } else if (oldValue !== undefined && oldValue !== null) {
          displayValue = String(oldValue);
        }
        td.textContent = displayValue;
      }

      
      selectCell(row, col);

      const displayOld = oldValue instanceof Date ? oldValue.toLocaleDateString() : oldValue;
      log(`Undo: Cell ${columnLetter(col)}${row + 1} restored to "${displayOld}"`, 'info');
    }

    function parseInputValue(str) {
      const trimmed = str.trim();

      
      if (trimmed.startsWith('=')) {
        return { isFormula: true, value: trimmed.slice(1) };
      }

      
      if (trimmed === '') {
        return { isFormula: false, value: '' };
      }

      
      if (trimmed.toLowerCase() === 'true') {
        return { isFormula: false, value: true };
      }
      if (trimmed.toLowerCase() === 'false') {
        return { isFormula: false, value: false };
      }

      
      const num = Number(trimmed);
      if (!isNaN(num) && trimmed !== '') {
        return { isFormula: false, value: num };
      }

      
      const dateMatch = trimmed.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (dateMatch) {
        const date = new Date(trimmed);
        if (!isNaN(date.getTime())) {
          return { isFormula: false, value: date };
        }
      }

      
      return { isFormula: false, value: trimmed };
    }

    function handleCellKeyDown(e) {
      
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      const preview = document.getElementById('preview');
      if (!preview || !preview.contains(e.target)) {
        return;
      }

      
      if (selectedRow === null || selectedCol === null) return;

      if (isEditing) {
        
        return;
      }

      
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undoLastEdit();
        return;
      }

      
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        copyCell();
        return;
      }

      
      if ((e.ctrlKey || e.metaKey) && e.key === 'x') {
        e.preventDefault();
        cutCell();
        return;
      }

      
      if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        e.preventDefault();
        pasteCell();
        return;
      }

      
      if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
        e.preventDefault();
        toggleBold();
        return;
      }

      
      if ((e.ctrlKey || e.metaKey) && e.key === 'i') {
        e.preventDefault();
        toggleItalic();
        return;
      }

      
      if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault();
        clearCell();
        return;
      }

      
      if (e.key === 'Enter' || e.key === 'F2') {
        e.preventDefault();
        startEditing(selectedRow, selectedCol);
        return;
      }

      
      if (e.key === 'ArrowUp') {
        e.preventDefault();
        moveSelection(-1, 0);
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        moveSelection(1, 0);
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        moveSelection(0, -1);
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        moveSelection(0, 1);
      } else if (e.key === 'Tab') {
        e.preventDefault();
        moveSelection(0, e.shiftKey ? -1 : 1);
      }

      
      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault();
        startEditing(selectedRow, selectedCol);
        
        const input = document.querySelector('td.editing input');
        if (input) {
          input.value = e.key;
          
          input.setSelectionRange(input.value.length, input.value.length);
        }
      }
    }

    function moveSelection(rowDelta, colDelta) {
      if (selectedRow === null || selectedCol === null) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      const dims = sheet.dimensions;
      if (!dims) return;

      
      const table = document.getElementById('previewTable');
      if (!table) return;

      const newRow = selectedRow + rowDelta;
      const newCol = selectedCol + colDelta;

      
      const newTd = document.querySelector(`td[data-row="${newRow}"][data-col="${newCol}"]`);
      if (newTd) {
        selectCell(newRow, newCol);
      }
    }

    function columnLetter(index) {
      let letter = '';
      while (index >= 0) {
        letter = String.fromCharCode(65 + (index % 26)) + letter;
        index = Math.floor(index / 26) - 1;
      }
      return letter;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
    }

    
    const textWidthCanvas = document.createElement('canvas');
    const textWidthCtx = textWidthCanvas.getContext('2d');
    function getTextWidth(text, font) {
      textWidthCtx.font = font;
      return textWidthCtx.measureText(text).width;
    }

    
    function cellStyleToCss(style) {
      if (!style) return '';

      let css = '';

      
      if (style.font) {
        const font = style.font;
        if (font.bold) css += 'font-weight: bold;';
        if (font.italic) css += 'font-style: italic;';
        if (font.underline) css += 'text-decoration: underline;';
        if (font.strikethrough) css += 'text-decoration: line-through;';
        if (font.color) css += `color: ${font.color};`;
        if (font.size) css += `font-size: ${font.size}pt;`;
        if (font.name) css += `font-family: "${font.name}", sans-serif;`;
      }

      if (style.fill) {
        const fill = style.fill;
        if (fill.type === 'pattern' && fill.pattern === 'solid' && fill.foregroundColor) {
          css += `background-color: ${fill.foregroundColor};`;
        }
      }

      
      if (style.alignment) {
        const align = style.alignment;
        if (align.horizontal) {
          css += `text-align: ${align.horizontal};`;
        }
        if (align.vertical) {
          const vAlign = align.vertical === 'middle' ? 'middle' :
                        align.vertical === 'top' ? 'top' : 'bottom';
          css += `vertical-align: ${vAlign};`;
        }
        if (align.wrapText) {
          css += 'white-space: pre-wrap;';
        }
        if (align.textRotation) {
          css += `writing-mode: vertical-rl; transform: rotate(${align.textRotation}deg);`;
        }
      }

      
      if (style.borders) {
        const borders = style.borders;
        if (borders.top) {
          css += `border-top: ${borderStyleToCss(borders.top)};`;
        }
        if (borders.right) {
          css += `border-right: ${borderStyleToCss(borders.right)};`;
        }
        if (borders.bottom) {
          css += `border-bottom: ${borderStyleToCss(borders.bottom)};`;
        }
        if (borders.left) {
          css += `border-left: ${borderStyleToCss(borders.left)};`;
        }
      }

      return css;
    }

    
    function borderStyleToCss(border) {
      if (!border) return 'none';

      const styleMap = {
        'thin': '1px solid',
        'medium': '2px solid',
        'thick': '3px solid',
        'dashed': '1px dashed',
        'dotted': '1px dotted',
        'double': '3px double',
        'hair': '1px solid',
        'dashDot': '1px dashed',
        'dashDotDot': '1px dashed',
        'mediumDashed': '2px dashed',
        'mediumDashDot': '2px dashed',
        'mediumDashDotDot': '2px dashed',
        'slantDashDot': '2px dashed'
      };

      const cssStyle = styleMap[border.style] || '1px solid';
      const color = border.color || '#000000';

      return `${cssStyle} ${color}`;
    }

    function reExportXlsx() {
      if (!window.currentWorkbook) return;

      log('Re-exporting as XLSX...');
      const blob = workbookToXlsxBlob(window.currentWorkbook);
      download(blob, 're-exported.xlsx');
      log('Downloaded re-exported.xlsx', 'success');
    }

    function reExportCsv() {
      if (!window.currentWorkbook) return;

      const sheet = window.currentWorkbook.sheets[window.currentSheetIndex];
      log(`Exporting sheet "${sheet.name}" as CSV...`);

      const csv = sheetToCsv(sheet);
      const blob = new Blob([csv], { type: 'text/csv' });
      download(blob, `${sheet.name}.csv`);
      log(`Downloaded ${sheet.name}.csv`, 'success');
    }

    document.getElementById('btnBasic').addEventListener('click', exportBasicExample);
    document.getElementById('btnStyled').addEventListener('click', exportStyledExample);
    document.getElementById('btnFormula').addEventListener('click', exportFormulaExample);
    document.getElementById('btnMultiSheet').addEventListener('click', exportMultiSheetExample);
    document.getElementById('btnComments').addEventListener('click', exportCommentsExample);
    document.getElementById('btnReExportXlsx').addEventListener('click', reExportXlsx);
    document.getElementById('btnReExportCsv').addEventListener('click', reExportCsv);
  </script>
</body>
</html>
